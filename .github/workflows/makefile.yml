name: Makefile CI

on:
  push:

    paths:
 
      - scripts/**
      - .github/workflows/**
      
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest
    

    steps:
      

    - uses: actions/checkout@v2
      with: 
        repository: ${{ github.repository }}
        token: ${{ github.token }} 
    - name: Run apt update
      run: sudo apt update 
      
    - name: Compile Hundalm
      uses: docker://pandoc/core:2.9 
      with:
        args: >-  # allows you to break string into multiple line 
          --output=./descriptions/hundalm.html
          --toc
          -s 
          --top-level-division=section
          --bibliography=./bibliography/tanguy_bib.bib
          --csl="https://raw.githubusercontent.com/citation-style-language/styles/master/elsevier-harvard.csl"
          --metadata title="Hundalm Tropfstein- und Eish√∂hle"
          ./descriptions/hundalm.md
    - name: Upload Files
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          title: Build ${{ github.run_number }}
          automatic_release_tag: "latest"
          prerelease: false
          files: ./descriptions/*.html
          

    - name: check for changes
      run: git status
    - name: stage changed files
      run: git add .
    - name: commit changed files
      env: |
        EMAIL: ${{ secrets.EMAIL }}
        USERNAME: ${{ secrets.USERNAME }}
      run: |
        git config --global user.email "$EMAIL"
        git config --global user.name "$USERNAME"
        git commit -m "Updating Files"
    - name: fetch from master
      run: git fetch origin master
    - name: push code to master
      run: git push origin HEAD:master
