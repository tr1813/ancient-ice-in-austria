name: Makefile CI

on:
  push:

    paths:
 
      - scripts/**
      - .github/workflows/**
      
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:

    runs-on: ubuntu-latest
    

    steps:
      

    - uses: actions/checkout@v2
      with: 
        repository: ${{ github.repository }}
        token: ${{ github.token }} 
    - name: Run apt update
      run: sudo apt update 
      
    - name: Compile Hundalm
      uses: docker://pandoc/core:2.9 
      with:
        args: >-  # allows you to break string into multiple line 
          --output=./descriptions/hundalm.html
          --toc
          -s 
          --top-level-division=section
          --bibliography=./bibliography/tanguy_bib.bib
          --csl="https://raw.githubusercontent.com/citation-style-language/styles/master/elsevier-harvard.csl"
          --metadata title="Hundalm Tropfstein- und Eish√∂hle"
          ./descriptions/hundalm.md
    - name: Upload Files
      uses: "marvinpinto/action-automatic-releases@latest"
      with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          title: Build ${{ github.run_number }}
          automatic_release_tag: "latest"
          prerelease: false
          files: ./descriptions/*.html
        
    - name: add origin 
      run: git remote set-url origin "${{ secrets.REMOTEURL  }}"

    - name: check for changes
      run: git status
    - name: stage changed files
      run: git add .
    - name: commit changed files
      shell: bash
      run: |
        git config --global user.email "${{ secrets.EMAIL }}"
        git config --global user.name "${{ secrets.EMAIL }}"
        git commit -m "Updating Files"
        
    - name: fetch from main
      shell: bash
      run: |
        git remote set-url origin "${{ secrets.REMOTEURL  }}"
        git fetch origin main
        
    - name: push code to main
      run: git push origin HEAD:main
